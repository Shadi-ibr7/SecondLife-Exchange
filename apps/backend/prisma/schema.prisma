// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum ExchangeStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
  CANCELLED
}

enum ItemCondition {
  NEW
  GOOD
  FAIR
  TO_REPAIR
}

enum ItemStatus {
  AVAILABLE
  PENDING
  TRADED
  ARCHIVED
}

enum ItemCategory {
  CLOTHING
  ELECTRONICS
  BOOKS
  HOME
  TOOLS
  TOYS
  SPORTS
  ART
  VINTAGE
  HANDCRAFT
  OTHER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String
  avatarUrl    String?
  roles        UserRole @default(USER)
  createdAt    DateTime @default(now())

  // Relations
  profile      UserProfile?
  refreshTokens RefreshToken[]
  exchangesRequested Exchange[] @relation("ExchangeRequester")
  exchangesResponded Exchange[] @relation("ExchangeResponder")
  items        Item[]

  @@map("users")
  @@index([email])
}

model UserProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  bio             String?
  location        String?
  preferencesJson Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model Exchange {
  id                  String          @id @default(cuid())
  requesterId         String
  responderId         String
  requestedItemTitle  String
  offeredItemTitle    String
  status              ExchangeStatus  @default(PENDING)
  createdAt           DateTime        @default(now())
  completedAt         DateTime?

  // Relations
  requester User @relation("ExchangeRequester", fields: [requesterId], references: [id])
  responder User @relation("ExchangeResponder", fields: [responderId], references: [id])

  @@map("exchanges")
  @@index([requesterId])
  @@index([responderId])
  @@index([status])
  @@index([createdAt])
}

model Item {
  id              String        @id @default(cuid())
  ownerId         String
  owner           User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  title           String
  description     String
  category        ItemCategory
  condition       ItemCondition
  status          ItemStatus    @default(AVAILABLE)
  photos          ItemPhoto[]
  tags            String[]
  aiSummary       String?       // résumé concis proposé par l'IA
  aiRepairTip     String?       // conseil réparation basique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("items")
  @@index([ownerId])
  @@index([category, condition, status])
}

model ItemPhoto {
  id        String   @id @default(cuid())
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  url       String   // URL publique (CDN Cloudinary)
  publicId  String   // identifiant Cloudinary pour suppression
  width     Int?
  height    Int?
  createdAt DateTime @default(now())

  @@map("item_photos")
  @@index([itemId])
}

model WeeklyTheme {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  startOfWeek DateTime    // Lundi 00:00:00 local (ou UTC) du thème
  impactText  String?     // Texte sur l'impact écologique du thème (exigence sujet)
  isActive    Boolean     @default(false)
  suggestions SuggestedItem[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("weekly_themes")
  @@index([startOfWeek])
  @@index([isActive])
}

model SuggestedItem {
  id              String   @id @default(cuid())
  themeId         String
  theme           WeeklyTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Champs issus de l'IA Gemini
  name            String
  category        String
  country         String
  era             String?
  materials       String?
  ecoReason       String?
  repairDifficulty String?   // "faible|moyenne|elevee"
  popularity      Int?       // 1..5
  tags            String[]
  photoRef        String?

  // Traces & contrôle qualité
  aiModel         String?
  aiPromptHash    String?
  aiRaw           Json?

  createdAt       DateTime @default(now())

  @@map("suggested_items")
  @@index([themeId, country])
  @@index([category])
  @@index([name])
}
